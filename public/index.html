<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="page-title">System Stats & OpenClaw Monitor</title>
    <link rel="stylesheet" href="css/styles.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@300;400;500;700&display=swap" rel="stylesheet">
</head>
<body>
    <!-- Header with Agent Name -->
    <div class="dashboard-header">
        <div class="header-left">
            <h1>System Stats & OpenClaw Monitor</h1>
        </div>
        <div class="header-right">
            <div class="agent-badge" id="agent-badge">
                <span class="agent-label">Agent:</span>
                <span class="agent-name" id="agent-name">Loading...</span>
            </div>
            <div class="api-status-header" id="api-status" style="cursor: pointer;">
                <div class="status-dot"></div>
                <span>API Inactive</span>
            </div>
            <div class="connection-status-header" id="connection-status">
                <div class="status-dot"></div>
                <span>Gateway Active</span>
            </div>
        </div>
    </div>

    <div class="container">
        <!-- System Metrics Row (Top) -->
        <div class="stats-bar stats-top">
            <div class="stat-card openclaw">
                <div class="status-indicator" id="openclaw-indicator"></div>
                <div class="stat-label">OpenClaw Active<br>74 processes + 4k TUI 3.4k CPU</div>
                <div class="service-detail">Gateway Running...</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="cpu-value">--</div>
                <div class="stat-label">CPU Load Avg<br>Last avg (4 cores)</div>
            </div>
            <div class="stat-card memory">
                <div class="stat-value" id="memory-value">--</div>
                <div class="stat-label">Memory<br>used vs total</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="disk-value">--</div>
                <div class="stat-label">Disk Usage<br>used vs total</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="uptime-value">--</div>
                <div class="stat-label">System Uptime<br>since boot</div>
            </div>
        </div>

        <!-- Business Metrics Row (Bottom) -->
        <div class="stats-bar stats-bottom">
            <div class="stat-card model-indicator">
                <div class="stat-value" id="model-value">Haiku</div>
                <div class="stat-label">Current Model<br>claude-3-haiku-20240307</div>
                <div class="model-badge" id="model-badge">haiku</div>
            </div>
            <div class="stat-card model-usage">
                <div class="stat-value" id="model-usage-primary">--</div>
                <div class="stat-label">Model Usage<br>(All-Time)</div>
                <div class="model-breakdown" id="model-breakdown">Sonnet: -% | Haiku: -% | Opus: -%</div>
            </div>
            <div class="stat-card cost-by-bot">
                <div class="stat-value" id="cost-by-bot-total">$0.00</div>
                <div class="stat-label">Agent Costs<br>(Usage API)</div>
                <div class="bot-breakdown" id="bot-breakdown">
                    <div class="agent-cost-header">
                        <span></span>
                        <span>today</span>
                        <span>all-time</span>
                        <span>est/day</span>
                    </div>
                    <div class="help-text" style="font-size:10px;">Configure agent keys via API settings</div>
                </div>
            </div>
            <div class="stat-card token-alltime">
                <div class="stat-value" id="today-cost">$0.00</div>
                <div class="stat-label">Today's Live<br>Usage Cost</div>
                <div class="token-cost" id="alltime-cost">All-Time: $0.00</div>
            </div>
            <div class="stat-card backup-indicator">
                <div class="stat-value" id="backup-size">275MB</div>
                <div class="stat-label">Backup Size<br>Last 72 hours</div>
                <div class="backup-time" id="backup-time">Just now</div>
            </div>
        </div>

        <!-- Main Content Area -->
        <div class="main-content">
            <!-- Left Panel -->
            <div class="left-panel">
                <!-- File Tree -->
                <div class="panel file-tree-panel">
                    <div class="panel-header">
                        <h3>File Tree <span id="file-tree-path">(~/loading...)</span></h3>
                    </div>
                    <div class="panel-content" id="file-tree">
                        <div class="loading">Loading...</div>
                    </div>
                </div>
            </div>

            <!-- Right Panel -->
            <div class="right-panel">
                <!-- Work Queue -->
                <div class="panel work-queue-panel">
                    <div class="panel-header">
                        <h3>Work Queue & Current Tasks</h3>
                        <span class="queue-status" id="queue-status">Atlas resting</span>
                    </div>
                    <div class="task-tabs">
                        <button class="tab-btn active" data-tab="ACTIVE">ACTIVE</button>
                        <button class="tab-btn" data-tab="STUCK">STUCK</button>
                        <button class="tab-btn" data-tab="ERROR">ERROR</button>
                        <button class="tab-btn" data-tab="COMPLETE">COMPLETE</button>
                    </div>
                    <div class="panel-content" id="work-queue">
                        <div class="loading">Waiting for work queue...</div>
                    </div>
                </div>

                <!-- Git Log -->
                <div class="panel git-log-panel">
                    <div class="panel-header">
                        <h3>Git Log (Last 20)</h3>
                    </div>
                    <div class="panel-content" id="git-log">
                        <div class="loading">Loading...</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Bottom Panel -->
        <div class="bottom-panel">
            <div class="panel logs-panel">
                <div class="panel-header">
                    <h3>Live Logs</h3>
                </div>
                <div class="panel-content" id="live-logs">
                    <div class="loading">Loading...</div>
                </div>
            </div>
        </div>
    </div>

    <!-- API Key Management Modal -->
    <div class="modal" id="api-modal" style="display: none;">
        <div class="modal-content modal-content-wide">
            <div class="modal-header">
                <h2 id="modal-title">API Key Management</h2>
                <button class="modal-close" id="modal-close">&times;</button>
            </div>

            <!-- Modal Tabs -->
            <div class="modal-tabs">
                <button class="modal-tab active" data-modal-tab="admin">Admin Key</button>
                <button class="modal-tab" data-modal-tab="agents">Agent Keys</button>
            </div>

            <!-- Admin Key Tab -->
            <div class="modal-body modal-tab-content active" id="tab-admin">
                <p class="modal-description">
                    The admin API key calls the Anthropic Usage Report API for org-level cost data.
                    Must be an admin key (prefix: sk-ant-admin...).
                </p>
                <div class="form-group">
                    <label for="admin-key-input">Admin API Key</label>
                    <input type="password" id="admin-key-input"
                           placeholder="sk-ant-admin01-..." class="api-key-input">
                    <p class="help-text">
                        Stored securely on the backend. Used for Usage Report API only.
                    </p>
                </div>
                <div class="form-group">
                    <label for="api-endpoint-input">Custom Endpoint (Optional)</label>
                    <input type="text" id="api-endpoint-input"
                           placeholder="https://api.anthropic.com/v1/organizations/usage_report/messages"
                           class="api-endpoint-input">
                    <p class="help-text">
                        Leave blank to use Anthropic's default API endpoint.
                    </p>
                </div>
                <div class="admin-key-status" id="admin-key-status"></div>
            </div>

            <!-- Agent Keys Tab -->
            <div class="modal-body modal-tab-content" id="tab-agents">
                <p class="modal-description">
                    Add API key IDs for each agent to track per-agent costs.
                    Find key IDs in the Anthropic Console under Settings &gt; API Keys.
                </p>

                <!-- Existing agent entries -->
                <div id="agent-entries-list"></div>

                <!-- Add new agent form -->
                <div class="agent-add-form">
                    <div class="form-row">
                        <div class="form-group form-group-half">
                            <label for="new-agent-name">Agent Name</label>
                            <input type="text" id="new-agent-name"
                                   placeholder="e.g., Atlas" class="api-key-input">
                        </div>
                        <div class="form-group form-group-half">
                            <label for="new-agent-keyid">API Key ID</label>
                            <input type="text" id="new-agent-keyid"
                                   placeholder="apikey_01Rj..." class="api-key-input">
                        </div>
                    </div>
                    <button class="btn-add-agent" id="btn-add-agent">+ Add Agent</button>
                </div>

                <!-- Lookup button -->
                <div class="agent-lookup-section" id="agent-lookup-section" style="display: none;">
                    <button class="btn-lookup" id="btn-lookup-keys">
                        Lookup Org Keys (via Admin API)
                    </button>
                    <div id="org-keys-dropdown" style="display: none;"></div>
                </div>
            </div>

            <div class="modal-footer">
                <button class="btn-cancel" id="btn-cancel">Cancel</button>
                <button class="btn-save" id="btn-save-api">Save Configuration</button>
            </div>
        </div>
    </div>

    <script src="js/dashboard.js"></script>
</body>
</html>
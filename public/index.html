<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="page-title">System Stats & OpenClaw Monitor</title>
    <link rel="stylesheet" href="css/styles.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@300;400;500;700&display=swap" rel="stylesheet">
</head>
<body>
    <!-- Header with Agent Name -->
    <div class="dashboard-header">
        <div class="header-left">
            <h1>System Stats & OpenClaw Monitor</h1>
        </div>
        <div class="header-right">
            <div class="agent-badge" id="agent-badge">
                <span class="agent-label">Host:</span>
                <span class="agent-name" id="agent-name">Loading...</span>
            </div>
            <div class="tracked-agents" id="tracked-agents"></div>
            <div class="api-status-header" id="api-status" style="cursor: pointer;">
                <div class="status-dot"></div>
                <span>API Inactive</span>
            </div>
            <div class="connection-status-header" id="connection-status">
                <div class="status-dot"></div>
                <span>Gateway Active</span>
            </div>
            <button class="btn-export" id="btn-export-csv" title="Export cost data as CSV">CSV</button>
            <div class="metrics-updated" id="metrics-updated">
                <span id="metrics-updated-text">Metrics: --</span>
            </div>
        </div>
    </div>

    <div class="container">
        <!-- System Metrics Row (Top) -->
        <div class="stats-bar stats-top">
            <div class="stat-card openclaw">
                <div class="status-indicator" id="openclaw-indicator"></div>
                <div class="stat-label">OpenClaw Active<br>74 processes + 4k TUI 3.4k CPU</div>
                <div class="service-detail">Gateway Running...</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="cpu-value">--</div>
                <div class="stat-label">CPU Load Avg<br>Last avg (4 cores)</div>
            </div>
            <div class="stat-card memory">
                <div class="stat-value" id="memory-value">--</div>
                <div class="stat-label">Memory<br>used vs total</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="disk-value">--</div>
                <div class="stat-label">Disk Usage<br>used vs total</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="uptime-value">--</div>
                <div class="stat-label">System Uptime<br>since boot</div>
            </div>
        </div>

        <!-- Business Metrics Row (Bottom) -->
        <div class="stats-bar stats-bottom">
            <div class="stat-card model-agent-card">
                <div class="model-current-row">
                    <span class="model-badge" id="model-badge">haiku</span>
                    <span class="model-current-name" id="model-value">Haiku</span>
                </div>
                <div class="stat-label">Model Usage (All-Time)</div>
                <div class="model-overall-breakdown" id="model-breakdown">
                    Sonnet: -% | Haiku: -% | Opus: -%
                </div>
                <div class="model-per-agent" id="model-per-agent"></div>
            </div>
            <div class="stat-card cost-by-bot">
                <div class="stat-value" id="cost-by-bot-total">$0.00</div>
                <div class="stat-label">Agent Costs<br>(estimated breakdown)</div>
                <div class="bot-breakdown" id="bot-breakdown">
                    <div class="agent-cost-header">
                        <span></span>
                        <span>today</span>
                        <span>all-time</span>
                        <span>est/day</span>
                    </div>
                    <div class="help-text" style="font-size:10px;">Configure agent keys via API settings</div>
                </div>
                <div class="agent-activity" id="agent-activity"></div>
            </div>
            <div class="stat-card token-alltime">
                <div class="stat-value" id="today-cost">$0.00</div>
                <div class="stat-label">Today's Live<br>Estimated Cost</div>
                <div class="token-cost" id="alltime-cost">All-Time (Actual): $0.00</div>
                <div class="token-projected" id="projected-monthly"></div>
                <div class="cost-trend" id="cost-trend"></div>
                <canvas id="cost-chart" height="50"></canvas>
            </div>
        </div>

        <!-- Main Content Area -->
        <div class="main-content">
            <!-- Left Panel -->
            <div class="left-panel">
                <!-- File Tree -->
                <div class="panel file-tree-panel">
                    <div class="panel-header">
                        <h3>File Tree <span id="file-tree-path">(~/loading...)</span></h3>
                    </div>
                    <div class="panel-content" id="file-tree">
                        <div class="loading">Loading...</div>
                    </div>
                </div>
            </div>

            <!-- Right Panel -->
            <div class="right-panel">
                <!-- Work Queue -->
                <div class="panel work-queue-panel">
                    <div class="panel-header">
                        <h3>Work Queue & Current Tasks</h3>
                        <span class="queue-status" id="queue-status">Atlas resting</span>
                    </div>
                    <div class="task-tabs">
                        <button class="tab-btn active" data-tab="ACTIVE">ACTIVE</button>
                        <button class="tab-btn" data-tab="BACKLOG">BACKLOG</button>
                        <button class="tab-btn" data-tab="STUCK">STUCK</button>
                        <button class="tab-btn" data-tab="ERROR">ERROR</button>
                        <button class="tab-btn" data-tab="COMPLETE">COMPLETE</button>
                    </div>
                    <div class="panel-content" id="work-queue">
                        <div class="loading">Waiting for work queue...</div>
                    </div>
                </div>

                <!-- Git Log -->
                <div class="panel git-log-panel">
                    <div class="panel-header">
                        <h3>Git Log (Last 20)</h3>
                    </div>
                    <div class="panel-content" id="git-log">
                        <div class="loading">Loading...</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Bottom Panel -->
        <div class="bottom-panel">
            <div class="panel logs-panel">
                <div class="panel-header">
                    <h3>Live Logs</h3>
                </div>
                <div class="log-filters">
                    <input type="text" id="log-search" class="log-search-input" placeholder="Search logs...">
                    <button class="log-level-btn active" data-level="info">INFO</button>
                    <button class="log-level-btn active" data-level="warning">WARN</button>
                    <button class="log-level-btn active" data-level="error">ERROR</button>
                    <button class="log-level-btn active" data-level="debug">DEBUG</button>
                </div>
                <div class="panel-content" id="live-logs">
                    <div class="loading">Loading...</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Debug Info Panel (collapsible) -->
    <div class="debug-panel" id="debug-panel">
        <div class="debug-header" id="debug-toggle">
            <span>Debug Info</span>
            <span class="debug-arrow" id="debug-arrow">â–¶</span>
        </div>
        <div class="debug-content" id="debug-content" style="display: none;">
            <pre id="debug-output">Waiting for data...</pre>
        </div>
    </div>

    <!-- API Key Management Modal -->
    <div class="modal" id="api-modal" style="display: none;">
        <div class="modal-content modal-content-wide">
            <div class="modal-header">
                <h2 id="modal-title">API Key Management</h2>
                <button class="modal-close" id="modal-close">&times;</button>
            </div>

            <!-- Modal Tabs -->
            <div class="modal-tabs">
                <button class="modal-tab active" data-modal-tab="admin">Admin Key</button>
                <button class="modal-tab" data-modal-tab="agents">Agent Keys</button>
                <button class="modal-tab" data-modal-tab="settings">Settings</button>
            </div>

            <!-- Admin Key Tab -->
            <div class="modal-body modal-tab-content active" id="tab-admin">
                <p class="modal-description">
                    The admin API key calls the Anthropic Cost Report API (actual billed costs)
                    and Usage Report API (live token estimates). Must be an admin key (prefix: sk-ant-admin...).
                </p>
                <div class="form-group">
                    <label for="admin-key-input">Admin API Key</label>
                    <input type="password" id="admin-key-input"
                           placeholder="sk-ant-admin01-..." class="api-key-input">
                    <p class="help-text">
                        Stored securely on the backend. Used for Cost Report + Usage Report APIs.
                    </p>
                </div>
                <div class="form-group">
                    <label for="api-endpoint-input">Custom Endpoint (Optional)</label>
                    <input type="text" id="api-endpoint-input"
                           placeholder="https://api.anthropic.com/v1/organizations/usage_report/messages"
                           class="api-endpoint-input">
                    <p class="help-text">
                        Leave blank to use Anthropic's default API endpoint.
                    </p>
                </div>
                <div class="admin-key-status" id="admin-key-status"></div>
            </div>

            <!-- Agent Keys Tab -->
            <div class="modal-body modal-tab-content" id="tab-agents">
                <p class="modal-description">
                    Add API key IDs for each agent to track per-agent costs.
                    Find key IDs in the Anthropic Console under Settings &gt; API Keys.
                </p>

                <!-- Existing agent entries -->
                <div id="agent-entries-list"></div>

                <!-- Add new agent form -->
                <div class="agent-add-form">
                    <div class="form-row">
                        <div class="form-group form-group-half">
                            <label for="new-agent-name">Agent Name</label>
                            <input type="text" id="new-agent-name"
                                   placeholder="e.g., Atlas" class="api-key-input">
                        </div>
                        <div class="form-group form-group-half">
                            <label for="new-agent-keyid">API Key ID</label>
                            <input type="text" id="new-agent-keyid"
                                   placeholder="apikey_01Rj..." class="api-key-input">
                        </div>
                    </div>
                    <button class="btn-add-agent" id="btn-add-agent">+ Add Agent</button>
                </div>

                <!-- Lookup button -->
                <div class="agent-lookup-section" id="agent-lookup-section" style="display: none;">
                    <button class="btn-lookup" id="btn-lookup-keys">
                        Lookup Org Keys (via Admin API)
                    </button>
                    <div id="org-keys-dropdown" style="display: none;"></div>
                </div>
            </div>

            <!-- Settings Tab -->
            <div class="modal-body modal-tab-content" id="tab-settings">
                <p class="modal-description">
                    Configure cost alerts and other dashboard settings.
                </p>
                <div class="form-group">
                    <label for="cost-threshold-input">Monthly Cost Alert Threshold ($)</label>
                    <input type="number" id="cost-threshold-input"
                           placeholder="e.g., 500" step="10" min="0"
                           class="api-key-input">
                    <p class="help-text">
                        Get a visual alert when projected monthly cost exceeds this amount. Leave blank to disable.
                    </p>
                </div>
                <button class="btn-save" id="btn-save-threshold" style="width:100%;">Save Threshold</button>
                <div class="admin-key-status" id="threshold-status" style="margin-top:8px;"></div>
            </div>

            <div class="modal-footer">
                <button class="btn-cancel" id="btn-cancel">Cancel</button>
                <button class="btn-save" id="btn-save-api">Save Configuration</button>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <script src="js/dashboard.js"></script>
</body>
</html>